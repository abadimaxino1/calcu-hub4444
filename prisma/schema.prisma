generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id              String              @id @default(uuid())
  email           String              @unique
  name            String
  hashedPassword  String
  role            Role                @default(VIEW_ONLY)
  isActive        Boolean             @default(true)
  totpSecret      String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  activityLogs    AdminActivityLog[]
  blogPosts       BlogPost[]
  sessions        Session[]
  staticPageEdits StaticPageContent[] @relation("LastEditor")

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userAgent String?
  ipAddress String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PageView {
  id          String   @id @default(uuid())
  sessionId   String
  userId      String?
  pagePath    String
  referrer    String?
  userAgent   String?
  country     String?
  device      String?
  browser     String?
  locale      String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  createdAt   DateTime @default(now())

  @@index([pagePath])
  @@index([createdAt])
  @@index([sessionId])
  @@index([utmSource])
  @@index([country])
  @@map("page_views")
}

model CalculationEvent {
  id             String   @id @default(uuid())
  sessionId      String
  userId         String?
  calculatorType String
  inputSummary   String
  resultSummary  String
  durationMs     Int      @default(0)
  locale         String?
  country        String?
  device         String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  createdAt      DateTime @default(now())

  @@index([calculatorType])
  @@index([createdAt])
  @@index([locale])
  @@map("calculation_events")
}

model AdEvent {
  id        String   @id @default(uuid())
  adSlotId  String
  eventType String
  sessionId String
  pagePath  String
  country   String?
  device    String?
  locale    String?
  ipAddress String?
  createdAt DateTime @default(now())
  adSlot    AdSlot   @relation(fields: [adSlotId], references: [id])

  @@index([adSlotId])
  @@index([createdAt])
  @@index([eventType])
  @@index([country])
  @@index([sessionId])
  @@map("ad_events")
}

model AdSlot {
  id              String    @id @default(uuid())
  name            String    @unique
  pagePathPattern String
  positionKey     String
  isActive        Boolean   @default(true)
  eCPM            Float     @default(0)
  cpc             Float     @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  events          AdEvent[]

  @@map("ad_slots")
}

model RevenueSnapshot {
  id            String   @id @default(uuid())
  source        String
  dateTime      DateTime
  revenueAmount Float
  currency      String   @default("SAR")
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  notes         String?
  createdAt     DateTime @default(now())

  @@index([dateTime])
  @@index([source])
  @@map("revenue_snapshots")
}

model SeoConfig {
  id              String   @id @default(uuid())
  pageKey         String
  locale          String   @default("ar")
  title           String
  description     String
  canonicalUrl    String?
  ogTitle         String?
  ogDescription   String?
  ogImageUrl      String?
  twitterCardType String   @default("summary_large_image")
  jsonLd          String?
  isIndexable     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([pageKey, locale])
  @@map("seo_configs")
}

model StaticPageContent {
  id             String   @id @default(uuid())
  slug           String
  locale         String   @default("ar")
  title          String
  bodyMarkdown   String
  lastEditedById String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastEditedBy   User?    @relation("LastEditor", fields: [lastEditedById], references: [id])

  @@unique([slug, locale])
  @@map("static_page_contents")
}

model BlogPost {
  id             String    @id @default(uuid())
  slug           String    @unique
  titleAr        String    @default("")
  titleEn        String    @default("")
  excerptAr      String    @default("")
  excerptEn      String    @default("")
  bodyMarkdownAr String    @default("")
  bodyMarkdownEn String    @default("")
  heroImageUrl   String?
  tags           String
  authorId       String
  isPublished    Boolean   @default(false)
  publishedAt    DateTime?
  viewCount      Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  author         User      @relation(fields: [authorId], references: [id])

  // Legacy fields for backward compatibility
  title          String    @default("")
  excerpt        String    @default("")
  bodyMarkdown   String    @default("")

  @@index([isPublished])
  @@index([publishedAt])
  @@map("blog_posts")
}

model FAQ {
  id          String   @id @default(uuid())
  category    String   // 'global', 'pay', 'eos', 'work', 'dates'
  questionAr  String   @default("")
  questionEn  String   @default("")
  answerAr    String   @default("")
  answerEn    String   @default("")
  sortOrder   Int      @default(0)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Legacy fields for backward compatibility
  locale      String   @default("ar")
  question    String   @default("")
  answer      String   @default("")

  @@index([category])
  @@index([isPublished])
  @@map("faqs")
}

model AdminActivityLog {
  id          String   @id @default(uuid())
  adminUserId String
  actionType  String
  targetType  String?
  targetId    String?
  detailsJson String?
  ipAddress   String?
  createdAt   DateTime @default(now())
  adminUser   User     @relation(fields: [adminUserId], references: [id])

  @@index([adminUserId])
  @@index([actionType])
  @@index([createdAt])
  @@map("admin_activity_logs")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  category  String   @default("general")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  isEnabled   Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("feature_flags")
}

model AnalyticsDaily {
  id             String   @id @default(uuid())
  date           DateTime @unique
  pageViews      Int      @default(0)
  uniqueVisitors Int      @default(0)
  calculations   Int      @default(0)
  adImpressions  Int      @default(0)
  adClicks       Int      @default(0)
  revenue        Float    @default(0)
  topPages       String?
  topCalculators String?
  createdAt      DateTime @default(now())

  @@index([date])
  @@map("analytics_daily")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  IT
  DESIGNER
  CONTENT_WRITER
  ADS_MANAGER
  ANALYST
  VIEW_ONLY
}

// ============================================
// Revenue Model & Monetization
// ============================================

model RevenueModel {
  id            String    @id @default(uuid())
  name          String    @unique
  description   String?
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)
  assumptions   String    // JSON: eCPM/CPC/CTR by slot, device, country
  createdById   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isActive])
  @@index([effectiveFrom])
  @@map("revenue_models")
}

model MonetizationAlert {
  id          String    @id @default(uuid())
  alertType   String    // HIGH_CTR, SUSPICIOUS_CLICKS, ABNORMAL_RPM, LOW_FILL_RATE
  severity    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  adSlotId    String?
  pagePath    String?
  country     String?
  device      String?
  periodStart DateTime
  periodEnd   DateTime
  metrics     String    // JSON: actual values, thresholds, deviations
  message     String
  isResolved  Boolean   @default(false)
  resolvedById String?
  resolvedAt  DateTime?
  resolvedNote String?
  createdAt   DateTime  @default(now())

  @@index([alertType])
  @@index([severity])
  @@index([isResolved])
  @@index([createdAt])
  @@map("monetization_alerts")
}

model TrafficSession {
  id          String   @id @default(uuid())
  sessionId   String   @unique
  firstPagePath String
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  country     String?
  device      String?
  locale      String?
  pageViews   Int      @default(1)
  calculations Int     @default(0)
  adImpressions Int    @default(0)
  adClicks    Int      @default(0)
  startedAt   DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  @@index([utmSource])
  @@index([referrer])
  @@index([startedAt])
  @@index([country])
  @@map("traffic_sessions")
}

// ============================================
// CMS: Tool Cards (Calculator listings)
// ============================================

model ToolCard {
  id                String   @id @default(uuid())
  slug              String   @unique // e.g., 'pay', 'eos', 'work', 'dates'
  titleAr           String
  titleEn           String
  descAr            String
  descEn            String
  icon              String   // emoji or icon name
  color             String   @default("from-blue-500 to-indigo-600") // gradient class
  sortOrder         Int      @default(0)
  isFeaturedOnHome  Boolean  @default(true)
  isVisibleOnTools  Boolean  @default(true)
  isPublished       Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isFeaturedOnHome])
  @@index([isVisibleOnTools])
  @@map("tool_cards")
}

// ============================================
// CMS: Benefit Features ("Why use our calculators?")
// ============================================

model BenefitFeature {
  id          String   @id @default(uuid())
  titleAr     String
  titleEn     String
  descAr      String
  descEn      String
  icon        String   // emoji or icon name
  sortOrder   Int      @default(0)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isPublished])
  @@map("benefit_features")
}

// ============================================
// AI Integration Configuration
// ============================================

model AIIntegration {
  id          String   @id @default(uuid())
  provider    String   @unique // 'openai', 'gemini', 'claude', etc.
  isEnabled   Boolean  @default(false)
  apiKey      String?  // Encrypted
  model       String?  // e.g., 'gpt-3.5-turbo', 'gemini-pro'
  features    String   // JSON array: ['content_generation', 'seo_optimization', 'translation']
  quota       Int      @default(0)  // Monthly quota
  used        Int      @default(0)  // Used this month
  lastReset   DateTime @default(now())
  config      String?  // JSON for provider-specific config
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_integrations")
}

model AIGeneratedContent {
  id          String   @id @default(uuid())
  contentType String   // 'blog_post', 'seo_meta', 'faq', 'description'
  targetId    String?  // ID of related content (blog post, page, etc.)
  prompt      String
  response    String
  provider    String   // 'openai', 'gemini', etc.
  model       String?
  tokensUsed  Int      @default(0)
  isApproved  Boolean  @default(false)
  approvedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([contentType])
  @@index([isApproved])
  @@index([createdAt])
  @@map("ai_generated_content")
}

// ============================================
// Revenue Projection & Goals
// ============================================

model RevenueGoal {
  id              String   @id @default(uuid())
  year            Int
  month           Int
  targetRevenue   Float    // Target revenue for the month
  targetPageviews Int      // Target pageviews
  targetRPM       Float    // Target RPM (Revenue per 1000 impressions)
  actualRevenue   Float    @default(0)
  actualPageviews Int      @default(0)
  actualRPM       Float    @default(0)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
  @@map("revenue_goals")
}

model RevenueProjection {
  id                String   @id @default(uuid())
  projectionDate    DateTime @unique
  projectedRevenue  Float
  confidence        String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  basedOnDays       Int      // Number of days of actual data used
  growthRate        Float    // Percentage growth rate
  seasonalFactor    Float    @default(1.0)
  assumptions       String   // JSON: RPM, traffic trends, etc.
  actualRevenue     Float?   // Filled in once the date passes
  accuracy          Float?   // Calculated after actual data is available
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([projectionDate])
  @@map("revenue_projections")
}

// ============================================
// Maintenance & System Health
// ============================================

model MaintenanceMode {
  id          String    @id @default(uuid())
  isEnabled   Boolean   @default(false)
  title       String    @default("الموقع قيد الصيانة / Site Under Maintenance")
  messageAr   String    @default("نعتذر عن الإزعاج. الموقع قيد الصيانة حالياً وسيعود قريباً.")
  messageEn   String    @default("Sorry for the inconvenience. The site is currently under maintenance and will be back soon.")
  startTime   DateTime?
  endTime     DateTime?
  allowedIPs  String?   // Comma-separated IPs that can access during maintenance
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("maintenance_mode")
}

model SystemHealth {
  id              String   @id @default(uuid())
  checkTime       DateTime @unique
  cpuUsage        Float?
  memoryUsage     Float?
  diskUsage       Float?
  responseTime    Int?     // Average response time in ms
  errorRate       Float?   // Percentage of errors
  activeUsers     Int?
  databaseSize    Float?   // Size in MB
  cacheHitRate    Float?
  status          String   @default("HEALTHY") // HEALTHY, WARNING, CRITICAL
  issues          String?  // JSON array of detected issues
  createdAt       DateTime @default(now())

  @@index([checkTime])
  @@index([status])
  @@map("system_health")
}

// ============================================
// Page Editor Tracking
// ============================================

model PageEdit {
  id          String   @id @default(uuid())
  pageSlug    String
  pagePath    String
  sectionId   String?  // ID of the section being edited
  editType    String   // 'content', 'seo', 'layout', 'settings'
  beforeData  String?  // JSON snapshot before edit
  afterData   String?  // JSON snapshot after edit
  editorId    String
  editorName  String
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pageSlug])
  @@index([editorId])
  @@index([createdAt])
  @@map("page_edits")
}
